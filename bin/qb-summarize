#!/bin/bash
# qutebrowser userscript: :summarize
# Summarizes the current page and opens the summary in a new tab.
# Runs on demand, no server needed.

export PATH="$HOME/.bun/bin:$PATH"
ELS_DIR="$HOME/Documents/elsummariz00r"

echo "message-info 'elsummariz00r: summarizing...'" >> "$QUTE_FIFO"

RESULT=$(CLAUDECODE= bun run "$ELS_DIR/src/index.ts" --json --title="$QUTE_TITLE" "$QUTE_URL" 2>/tmp/els-summarize.log)

HTML_PATH=$(echo "$RESULT" | python3 -c "import sys,json; print(json.load(sys.stdin)['htmlPath'])" 2>/dev/null)

CACHED=$(echo "$RESULT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('cached',False))" 2>/dev/null)

if [ -n "$HTML_PATH" ]; then
  if [ "$CACHED" = "True" ]; then
    echo "message-info 'elsummariz00r: already summarized, opening cached'" >> "$QUTE_FIFO"
  fi
  echo "open -t file://$HTML_PATH" >> "$QUTE_FIFO"
else
  ERROR=$(echo "$RESULT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('error','unknown error'))" 2>/dev/null)
  echo "message-error 'elsummariz00r: ${ERROR:-failed}'" >> "$QUTE_FIFO"
fi
